<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notas de clases – Ventilación Mecánica I</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body{font-family:'Poppins',sans-serif;background:#f9f9fb;color:#333}
    .container{max-width:960px}
    .card{border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.06);border:none;margin-bottom:1.2rem}
    .card-header{background:#eef2ff;color:#2563eb;font-weight:700}
    .rubric-table th,.rubric-table td{vertical-align:middle;text-align:center}
    .rubric-table th:first-child,.rubric-table td:first-child{text-align:left;width:40%}
    .score-options-wrapper{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center}
    .score-value{font-size:11px;color:#555}
    .form-check-input[type=radio]{transform:scale(1.15)}
    #totalScoreCard{background:#e0f2fe;border:1px solid #bae6fd}
    #totalScoreCard h4{color:#0369a1;font-weight:700}
    @media print{
      body{background:#fff}
      .container{max-width:100%;margin:0;padding:0}
      .card,.card-header,.card-body{box-shadow:none;border:1px solid #ddd}
      header,#buttonsCard{display:none}
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <header class="text-center mb-4">
      <h1 class="h3 text-primary">Rúbrica – Clases teóricas</h1>
      <p class="text-muted mb-0">Curso Ventilación Mecánica I</p>
      <p><a href="index.html" class="small">← Volver al inicio</a></p>
    </header>

    <form id="rubricForm" class="needs-validation" novalidate>
      <section class="card">
        <div class="card-header">Información general</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="evaluatorName">Evaluador</label>
              <input class="form-control" id="evaluatorName" required placeholder="Su nombre" />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="residentName">Residente evaluado</label>
              <input class="form-control" id="residentName" required placeholder="Nombre del residente" />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="evaluationDate">Fecha</label>
              <input type="date" class="form-control" id="evaluationDate" required />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="classTopic">Tema</label>
              <input class="form-control" id="classTopic" required placeholder="Tema evaluado" />
            </div>
          </div>
        </div>
      </section>

      <section class="card rubric-section" data-max-score="25" id="section1">
        <div class="card-header">I. Preparación y organización (25 pts) <span class="float-end text-muted score-display">Puntos: 0 / 25</span></div>
        <div class="card-body p-0">
          <table class="table mb-0 rubric-table">
            <tbody>
              <tr>
                <td>Dominio del tema</td>
                <td>
                  <div class="score-options-wrapper">
                    <label class="score-value">5</label><input class="form-check-input" type="radio" name="dominioTema" value="5" required>
                    <label class="score-value">4</label><input class="form-check-input" type="radio" name="dominioTema" value="4">
                    <label class="score-value">3</label><input class="form-check-input" type="radio" name="dominioTema" value="3">
                    <label class="score-value">1</label><input class="form-check-input" type="radio" name="dominioTema" value="1">
                    <label class="score-value">0</label><input class="form-check-input" type="radio" name="dominioTema" value="0">
                  </div>
                </td>
              </tr>
              <tr>
                <td>Organización de la clase</td>
                <td>
                  <div class="score-options-wrapper">
                    <label class="score-value">5</label><input class="form-check-input" type="radio" name="organizacionClase" value="5" required>
                    <label class="score-value">4</label><input class="form-check-input" type="radio" name="organizacionClase" value="4">
                    <label class="score-value">3</label><input class="form-check-input" type="radio" name="organizacionClase" value="3">
                    <label class="score-value">1</label><input class="form-check-input" type="radio" name="organizacionClase" value="1">
                    <label class="score-value">0</label><input class="form-check-input" type="radio" name="organizacionClase" value="0">
                  </div>
                </td>
              </tr>
              <tr>
                <td>Objetivos claros</td>
                <td>
                  <div class="score-options-wrapper">
                    <label class="score-value">5</label><input class="form-check-input" type="radio" name="objetivosClaros" value="5" required>
                    <label class="score-value">4</label><input class="form-check-input" type="radio" name="objetivosClaros" value="4">
                    <label class="score-value">3</label><input class="form-check-input" type="radio" name="objetivosClaros" value="3">
                    <label class="score-value">1</label><input class="form-check-input" type="radio" name="objetivosClaros" value="1">
                    <label class="score-value">0</label><input class="form-check-input" type="radio" name="objetivosClaros" value="0">
                  </div>
                </td>
              </tr>
              <tr>
                <td>Material de apoyo</td>
                <td>
                  <div class="score-options-wrapper">
                    <label class="score-value">5</label><input class="form-check-input" type="radio" name="materialApoyo" value="5" required>
                    <label class="score-value">4</label><input class="form-check-input" type="radio" name="materialApoyo" value="4">
                    <label class="score-value">3</label><input class="form-check-input" type="radio" name="materialApoyo" value="3">
                    <label class="score-value">1</label><input class="form-check-input" type="radio" name="materialApoyo" value="1">
                    <label class="score-value">0</label><input class="form-check-input" type="radio" name="materialApoyo" value="0">
                  </div>
                </td>
              </tr>
              <tr>
                <td>Manejo del tiempo</td>
                <td>
                  <div class="score-options-wrapper">
                    <label class="score-value">5</label><input class="form-check-input" type="radio" name="manejoTiempo" value="5" required>
                    <label class="score-value">4</label><input class="form-check-input" type="radio" name="manejoTiempo" value="4">
                    <label class="score-value">3</label><input class="form-check-input" type="radio" name="manejoTiempo" value="3">
                    <label class="score-value">1</label><input class="form-check-input" type="radio" name="manejoTiempo" value="1">
                    <label class="score-value">0</label><input class="form-check-input" type="radio" name="manejoTiempo" value="0">
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card rubric-section" data-max-score="35" id="section2">
        <div class="card-header">II. Metodología y habilidades de enseñanza (35 pts) <span class="float-end text-muted score-display">Puntos: 0 / 35</span></div>
        <div class="card-body p-0">
          <table class="table mb-0 rubric-table"><tbody>
            <tr><td>Claridad en la exposición</td><td><div class="score-options-wrapper">
              <label class="score-value">7</label><input class="form-check-input" type="radio" name="claridadExpo" value="7" required>
              <label class="score-value">6</label><input class="form-check-input" type="radio" name="claridadExpo" value="6">
              <label class="score-value">5</label><input class="form-check-input" type="radio" name="claridadExpo" value="5">
              <label class="score-value">4</label><input class="form-check-input" type="radio" name="claridadExpo" value="4">
              <label class="score-value">3</label><input class="form-check-input" type="radio" name="claridadExpo" value="3">
              <label class="score-value">2</label><input class="form-check-input" type="radio" name="claridadExpo" value="2">
              <label class="score-value">1</label><input class="form-check-input" type="radio" name="claridadExpo" value="1">
              <label class="score-value">0</label><input class="form-check-input" type="radio" name="claridadExpo" value="0">
            </div></td></tr>
            <tr><td>Fomento de la participación</td><td><div class="score-options-wrapper">
              <label class="score-value">7</label><input class="form-check-input" type="radio" name="fomentoPart" value="7" required>
              <label class="score-value">6</label><input class="form-check-input" type="radio" name="fomentoPart" value="6">
              <label class="score-value">5</label><input class="form-check-input" type="radio" name="fomentoPart" value="5">
              <label class="score-value">4</label><input class="form-check-input" type="radio" name="fomentoPart" value="4">
              <label class="score-value">3</label><input class="form-check-input" type="radio" name="fomentoPart" value="3">
              <label class="score-value">2</label><input class="form-check-input" type="radio" name="fomentoPart" value="2">
              <label class="score-value">1</label><input class="form-check-input" type="radio" name="fomentoPart" value="1">
              <label class="score-value">0</label><input class="form-check-input" type="radio" name="fomentoPart" value="0">
            </div></td></tr>
            <tr><td>Uso de ejemplos/casos</td><td><div class="score-options-wrapper">
              <label class="score-value">7</label><input class="form-check-input" type="radio" name="usoEjemplos" value="7" required>
              <label class="score-value">6</label><input class="form-check-input" type="radio" name="usoEjemplos" value="6">
              <label class="score-value">5</label><input class="form-check-input" type="radio" name="usoEjemplos" value="5">
              <label class="score-value">4</label><input class="form-check-input" type="radio" name="usoEjemplos" value="4">
              <label class="score-value">3</label><input class="form-check-input" type="radio" name="usoEjemplos" value="3">
              <label class="score-value">2</label><input class="form-check-input" type="radio" name="usoEjemplos" value="2">
              <label class="score-value">1</label><input class="form-check-input" type="radio" name="usoEjemplos" value="1">
              <label class="score-value">0</label><input class="form-check-input" type="radio" name="usoEjemplos" value="0">
            </div></td></tr>
            <tr><td>Adaptación al nivel</td><td><div class="score-options-wrapper">
              <label class="score-value">7</label><input class="form-check-input" type="radio" name="adaptacionNivel" value="7" required>
              <label class="score-value">6</label><input class="form-check-input" type="radio" name="adaptacionNivel" value="6">
              <label class="score-value">5</label><input class="form-check-input" type="radio" name="adaptacionNivel" value="5">
              <label class="score-value">4</label><input class="form-check-input" type="radio" name="adaptacionNivel" value="4">
              <label class="score-value">3</label><input class="form-check-input" type="radio" name="adaptacionNivel" value="3">
              <label class="score-value">2</label><input class="form-check-input" type="radio" name="adaptacionNivel" value="2">
              <label class="score-value">1</label><input class="form-check-input" type="radio" name="adaptacionNivel" value="1">
              <label class="score-value">0</label><input class="form-check-input" type="radio" name="adaptacionNivel" value="0">
            </div></td></tr>
            <tr><td>Entusiasmo e interés</td><td><div class="score-options-wrapper">
              <label class="score-value">7</label><input class="form-check-input" type="radio" name="entusiasmoInteres" value="7" required>
              <label class="score-value">6</label><input class="form-check-input" type="radio" name="entusiasmoInteres" value="6">
              <label class="score-value">5</label><input class="form-check-input" type="radio" name="entusiasmoInteres" value="5">
              <label class="score-value">4</label><input class="form-check-input" type="radio" name="entusiasmoInteres" value="4">
              <label class="score-value">3</label><input class="form-check-input" type="radio" name="entusiasmoInteres" value="3">
              <label class="score-value">2</label><input class="form-check-input" type="radio" name="entusiasmoInteres" value="2">
              <label class="score-value">1</label><input class="form-check-input" type="radio" name="entusiasmoInteres" value="1">
              <label class="score-value">0</label><input class="form-check-input" type="radio" name="entusiasmoInteres" value="0">
            </div></td></tr>
          </tbody></table>
        </div>
      </section>

      <section class="card rubric-section" data-max-score="15" id="section3">
        <div class="card-header">III. Interacción y comunicación (15 pts) <span class="float-end text-muted score-display">Puntos: 0 / 15</span></div>
        <div class="card-body p-0"><table class="table mb-0 rubric-table"><tbody>
          <tr><td>Habilidad de escucha</td><td><div class="score-options-wrapper">
            <label class="score-value">5</label><input class="form-check-input" type="radio" name="habilidadEscucha" value="5" required>
            <label class="score-value">4</label><input class="form-check-input" type="radio" name="habilidadEscucha" value="4">
            <label class="score-value">3</label><input class="form-check-input" type="radio" name="habilidadEscucha" value="3">
            <label class="score-value">1</label><input class="form-check-input" type="radio" name="habilidadEscucha" value="1">
            <label class="score-value">0</label><input class="form-check-input" type="radio" name="habilidadEscucha" value="0">
          </div></td></tr>
          <tr><td>Respeto y profesionalismo</td><td><div class="score-options-wrapper">
            <label class="score-value">5</label><input class="form-check-input" type="radio" name="respetoProf" value="5" required>
            <label class="score-value">4</label><input class="form-check-input" type="radio" name="respetoProf" value="4">
            <label class="score-value">3</label><input class="form-check-input" type="radio" name="respetoProf" value="3">
            <label class="score-value">1</label><input class="form-check-input" type="radio" name="respetoProf" value="1">
            <label class="score-value">0</label><input class="form-check-input" type="radio" name="respetoProf" value="0">
          </div></td></tr>
          <tr><td>Comunicación no verbal</td><td><div class="score-options-wrapper">
            <label class="score-value">5</label><input class="form-check-input" type="radio" name="comunicacionNV" value="5" required>
            <label class="score-value">4</label><input class="form-check-input" type="radio" name="comunicacionNV" value="4">
            <label class="score-value">3</label><input class="form-check-input" type="radio" name="comunicacionNV" value="3">
            <label class="score-value">1</label><input class="form-check-input" type="radio" name="comunicacionNV" value="1">
            <label class="score-value">0</label><input class="form-check-input" type="radio" name="comunicacionNV" value="0">
          </div></td></tr>
        </tbody></table></div>
      </section>

      <section class="card rubric-section" data-max-score="15" id="section4">
        <div class="card-header">IV. Relevancia clínica y aplicabilidad (15 pts) <span class="float-end text-muted score-display">Puntos: 0 / 15</span></div>
        <div class="card-body p-0"><table class="table mb-0 rubric-table"><tbody>
          <tr><td>Conexión con la práctica</td><td><div class="score-options-wrapper">
            <label class="score-value">5</label><input class="form-check-input" type="radio" name="conexionPractica" value="5" required>
            <label class="score-value">4</label><input class="form-check-input" type="radio" name="conexionPractica" value="4">
            <label class="score-value">3</label><input class="form-check-input" type="radio" name="conexionPractica" value="3">
            <label class="score-value">1</label><input class="form-check-input" type="radio" name="conexionPractica" value="1">
            <label class="score-value">0</label><input class="form-check-input" type="radio" name="conexionPractica" value="0">
          </div></td></tr>
          <tr><td>Fomento del pensamiento crítico</td><td><div class="score-options-wrapper">
            <label class="score-value">5</label><input class="form-check-input" type="radio" name="fomentoPensamiento" value="5" required>
            <label class="score-value">4</label><input class="form-check-input" type="radio" name="fomentoPensamiento" value="4">
            <label class="score-value">3</label><input class="form-check-input" type="radio" name="fomentoPensamiento" value="3">
            <label class="score-value">1</label><input class="form-check-input" type="radio" name="fomentoPensamiento" value="1">
            <label class="score-value">0</label><input class="form-check-input" type="radio" name="fomentoPensamiento" value="0">
          </div></td></tr>
          <tr><td>Actualización del contenido</td><td><div class="score-options-wrapper">
            <label class="score-value">5</label><input class="form-check-input" type="radio" name="actualizacionCont" value="5" required>
            <label class="score-value">4</label><input class="form-check-input" type="radio" name="actualizacionCont" value="4">
            <label class="score-value">3</label><input class="form-check-input" type="radio" name="actualizacionCont" value="3">
            <label class="score-value">1</label><input class="form-check-input" type="radio" name="actualizacionCont" value="1">
            <label class="score-value">0</label><input class="form-check-input" type="radio" name="actualizacionCont" value="0">
          </div></td></tr>
        </tbody></table></div>
      </section>

      <section class="card" id="totalScoreCardScreen">
        <div id="totalScoreCard" class="card-body text-center">
          <h4>Puntuación Total: <span id="totalScoreDisplay">0 / 100</span></h4>
        </div>
      </section>

      <section class="card" id="buttonsCard">
        <div class="card-footer text-center">
          <button type="button" id="calculateButton" class="btn btn-primary me-2">Validar y Calcular</button>
          <button type="button" id="saveGoogleButton" class="btn btn-info me-2" disabled>Guardar en Google</button>
          <button type="button" id="exportPdfButton" class="btn btn-success" disabled>Exportar PDF</button>
          <button type="reset" id="resetButton" class="btn btn-warning ms-2">Limpiar</button>
        </div>
      </section>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // URL de tu Web App de Google Apps Script
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbzGcsKBngQUT9Yn1bmhBXDaVsQxWUC_XpTOE9ORU8GarPQSCFyHgqd92SCewj1puFy_/exec';
      
      // Función para convertir ArrayBuffer a Base64
      function ab2b64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
      }
      
      const form = document.getElementById('rubricForm');
      const totalScoreDisplay = document.getElementById('totalScoreDisplay');
      const exportPdfButton = document.getElementById('exportPdfButton');
      const saveGoogleButton = document.getElementById('saveGoogleButton');
      const resetButton = document.getElementById('resetButton');
      const calculateButton = document.getElementById('calculateButton');
      const rubricSections = document.querySelectorAll('.rubric-section');
      const directMaxScore = 90;
      const finalMaxScore = 100;

      // Función para calcular el puntaje de una sección
      function calculateSectionScore(section) {
        let score = 0;
        section.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
          const value = parseInt(radio.value, 10);
          if (!isNaN(value)) score += value;
        });
        return score;
      }

      // Función para actualizar los puntajes en pantalla
      function updateScoresDisplay() {
        let totalDirect = 0;
        
        rubricSections.forEach(section => {
          const sectionScore = calculateSectionScore(section);
          const maxScore = parseInt(section.dataset.maxScore, 10);
          const display = section.querySelector('.score-display');
          
          if (display) {
            display.textContent = `Puntos: ${sectionScore} / ${maxScore}`;
          }
          
          totalDirect += sectionScore;
        });

        // Escalar el puntaje a 100
        const scaledScore = (totalDirect / directMaxScore) * finalMaxScore;
        const finalScore = Math.round(scaledScore * 10) / 10;
        
        totalScoreDisplay.textContent = `${finalScore} / ${finalMaxScore}`;
        
        return { finalScore };
      }

      // Evento cuando se selecciona un radio button
      form.addEventListener('change', e => {
        if (e.target.type === 'radio') {
          updateScoresDisplay();
          exportPdfButton.disabled = true;
          saveGoogleButton.disabled = true;
          form.classList.remove('was-validated');
        }
      });

      // Evento para el botón de resetear
      resetButton.addEventListener('click', () => {
        form.reset();
        
        rubricSections.forEach(section => {
          const maxScore = parseInt(section.dataset.maxScore, 10);
          const display = section.querySelector('.score-display');
          if (display) {
            display.textContent = `Puntos: 0 / ${maxScore}`;
          }
        });
        
        totalScoreDisplay.textContent = '0 / 100';
        exportPdfButton.disabled = true;
        saveGoogleButton.disabled = true;
      });

      // Evento para validar y calcular
      calculateButton.addEventListener('click', () => {
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          alert('Por favor, complete todos los criterios de evaluación.');
        } else {
          form.classList.remove('was-validated');
          updateScoresDisplay();
          exportPdfButton.disabled = false;
          saveGoogleButton.disabled = false;
        }
      });

      // Función para construir el PDF
      async function buildPdf() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        
        const margin = 10;
        const pdfW = pdf.internal.pageSize.getWidth();
        let y = margin;
        let page = 1;
        const footer = 10;
        const avail = pdf.internal.pageSize.getHeight() - margin - footer;

        // Función para agregar encabezado y pie de página
        function addHeaderFooter() {
          pdf.setFontSize(8);
          pdf.setTextColor(150);
          const timestamp = new Date().toLocaleString('es-NI', { timeZone: 'America/Managua' });
          pdf.text(`Generado: ${timestamp}`, margin, pdf.internal.pageSize.getHeight() - margin + 5);
          pdf.text(`Página ${page}`, pdfW - margin, pdf.internal.pageSize.getHeight() - margin + 5, { align: 'right' });
          pdf.setTextColor(51);
        }

        // Función para capturar elemento como imagen
        async function captureElement(id) {
          const element = document.getElementById(id);
          if (!element) return null;
          
          const originalDisplay = element.style.display;
          element.style.display = 'block';
          
          await new Promise(resolve => setTimeout(resolve, 30));
          
          let canvas;
          try {
            canvas = await html2canvas(element, { scale: 1.5, backgroundColor: '#fff' });
          } catch {
            canvas = null;
          }
          
          element.style.display = originalDisplay;
          
          return canvas ? canvas.toDataURL('image/png', 0.92) : null;
        }

        // Función para agregar imagen al PDF
        function addImage(imgData, element) {
          if (!imgData || !element) return;
          
          const contentWidth = pdfW - (margin * 2);
          const imgHeight = (element.offsetHeight * contentWidth) / element.offsetWidth;
          
          if (y + imgHeight > avail) {
            addHeaderFooter();
            pdf.addPage();
            page++;
            y = margin;
          }
          
          pdf.addImage(imgData, 'PNG', margin, y, contentWidth, imgHeight);
          y += imgHeight + 5;
        }

        // Título del documento
        pdf.setFont('helvetica', 'bold');
        pdf.setFontSize(16);
        pdf.setTextColor(37, 99, 235);
        pdf.text('Reporte – Clases teóricas', pdfW / 2, y, { align: 'center' });
        y += 10;
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(51);

        // Capturar y agregar el formulario (ocultando los botones)
        const buttonsCard = document.getElementById('buttonsCard');
        buttonsCard.style.display = 'none';
        
        const formImg = await captureElement('rubricForm');
        addImage(formImg, document.getElementById('rubricForm'));
        
        buttonsCard.style.display = 'block';

        addHeaderFooter();
        
        return pdf;
      }

      // Evento para exportar PDF
      exportPdfButton.addEventListener('click', async () => {
        exportPdfButton.disabled = true;
        exportPdfButton.textContent = 'Generando PDF...';
        
        try {
          const pdf = await buildPdf();
          const residentName = (document.getElementById('residentName').value || 'Residente').replace(/\s+/g, '_');
          const date = document.getElementById('evaluationDate').value || new Date().toISOString().slice(0, 10);
          pdf.save(`Notas_Clases_${residentName}_${date}.pdf`);
        } catch (e) {
          console.error(e);
          alert('Error al generar el PDF: ' + e.message);
        } finally {
          exportPdfButton.disabled = false;
          exportPdfButton.textContent = 'Exportar PDF';
        }
      });

      // Evento para guardar en Google
      saveGoogleButton.addEventListener('click', async () => {
        saveGoogleButton.disabled = true;
        saveGoogleButton.textContent = 'Guardando...';

        try {
          const pdf = await buildPdf();
          const pdfArrayBuffer = pdf.output('arraybuffer');
          
          const meta = {
            evaluator: document.getElementById('evaluatorName').value || '',
            resident: document.getElementById('residentName').value || '',
            date: document.getElementById('evaluationDate').value || '',
            topic: document.getElementById('classTopic').value || '',
            total: totalScoreDisplay.textContent,
            fileName: `Notas_Clases_${(document.getElementById('residentName').value || 'Residente').replace(/\s+/g, '_')}_${document.getElementById('evaluationDate').value || new Date().toISOString().slice(0, 10)}.pdf`
          };

          const payload = {
            type: 'clases',
            meta: meta,
            pdfBase64: ab2b64(pdfArrayBuffer)
          };

          console.log('Enviando datos a:', GAS_URL);

          const response = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify(payload)
          });

          alert('¡Datos enviados correctamente! Por favor, verifica tu Google Sheet y Drive.');

        } catch (e) {
          console.error('Error detallado:', e);
          alert('Error al guardar en Google: ' + e.message);
        } finally {
          saveGoogleButton.disabled = false;
          saveGoogleButton.textContent = 'Guardar en Google';
        }
      });
    });
  </script>
</body>
</html>
